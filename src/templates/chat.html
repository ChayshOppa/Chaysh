{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white dark:bg-gray-800 rounded-ios shadow-lg overflow-hidden transition-all duration-200 ios-gradient">
        <div class="p-6">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6 text-center" id="chat-title">Chat CTC</h1>
            
            <!-- Chat Container -->
            <div class="chat-container h-[500px] overflow-y-auto mb-6 p-4 bg-gray-50 dark:bg-gray-700/30 rounded-ios" id="chat-container"></div>
            
            <!-- Input Container -->
            <div class="flex gap-4">
                <input type="text" 
                       id="query-input" 
                       class="flex-grow px-4 py-3 rounded-ios border-2 border-gray-200 dark:border-gray-700 
                              bg-white dark:bg-gray-800 text-gray-900 dark:text-white
                              focus:border-primary-500 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-800
                              transition-all duration-200"
                       placeholder="Ask me anything..."
                       autocomplete="off">
                <button onclick="sendQuery()" 
                        class="px-6 py-3 bg-primary-500 text-white rounded-ios hover:bg-primary-600 
                               transition-all duration-200 font-medium">
                    Send
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Chat specific styles */
    .chat-container {
        scrollbar-width: thin;
        scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }

    .chat-container::-webkit-scrollbar {
        width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 3px;
    }

    .message {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<script>
    const chatContainer = document.getElementById('chat-container');
    const queryInput = document.getElementById('query-input');
    const chatTitle = document.getElementById('chat-title');
    const sendButton = document.querySelector('button[onclick="sendQuery()"]');
    const MAX_INPUT_LENGTH = 600;
    const MAX_OUTPUT_LENGTH = 300;

    // Chat-specific translations
    const chatTranslations = {
        en: {
            title: 'Chat CTC',
            placeholder: 'Ask me anything...',
            send: 'Send',
            error: 'An error occurred while processing your request.',
            thinking: 'Thinking...',
            messageTooLong: 'Message too long ({{length}}/{{max}} characters)'
        },
        pl: {
            title: 'Chat CTC (Chaysh to Człowieku)',
            placeholder: 'Zapytaj mnie o cokolwiek...',
            send: 'Wyślij',
            error: 'Wystąpił błąd podczas przetwarzania żądania.',
            thinking: 'Myślę...',
            messageTooLong: 'Wiadomość zbyt długa ({{length}}/{{max}} znaków)'
        }
    };

    // Update chat UI text based on language
    function updateChatUIText(lang) {
        const t = chatTranslations[lang];
        chatTitle.textContent = t.title;
        queryInput.placeholder = t.placeholder;
        sendButton.textContent = t.send;
    }

    // Initialize chat UI with saved language
    const savedLang = getCookie('lang') || 'en';
    updateChatUIText(savedLang);

    // Listen for language changes
    document.addEventListener('languageChanged', (e) => {
        updateChatUIText(e.detail.lang);
    });

    // Send query function
    async function sendQuery() {
        const query = queryInput.value.trim();
        if (!query) return;

        // Check input length
        if (query.length > MAX_INPUT_LENGTH) {
            alert(chatTranslations[savedLang].messageTooLong
                .replace('{{length}}', query.length)
                .replace('{{max}}', MAX_INPUT_LENGTH));
            return;
        }

        // Add user message
        addMessage('user', query);
        queryInput.value = '';

        // Add thinking indicator
        const thinkingId = addMessage('assistant', chatTranslations[savedLang].thinking, true);

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            // Remove thinking indicator
            removeMessage(thinkingId);

            // Add assistant response
            addMessage('assistant', data.response);

        } catch (error) {
            console.error('Chat error:', error);
            removeMessage(thinkingId);
            addMessage('error', chatTranslations[savedLang].error);
        }
    }

    // Add message to chat
    function addMessage(role, content, isThinking = false) {
        const messageDiv = document.createElement('div');
        const messageId = Date.now();
        messageDiv.id = `message-${messageId}`;
        messageDiv.className = `message mb-4 ${role === 'user' ? 'text-right' : ''}`;

        const bubble = document.createElement('div');
        bubble.className = `inline-block px-4 py-2 rounded-ios max-w-[80%] ${
            role === 'user' 
                ? 'bg-primary-500 text-white' 
                : role === 'error'
                    ? 'bg-red-500 text-white'
                    : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white'
        }`;

        if (isThinking) {
            bubble.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-current rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-current rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-current rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            `;
        } else {
            bubble.textContent = content;
        }

        messageDiv.appendChild(bubble);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return messageId;
    }

    // Remove message from chat
    function removeMessage(messageId) {
        const message = document.getElementById(`message-${messageId}`);
        if (message) {
            message.remove();
        }
    }

    // Handle Enter key
    queryInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendQuery();
        }
    });

    // Focus input on load
    queryInput.focus();
</script>
{% endblock %} 