{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <!-- Hidden system tip -->
    <div id="system-tip" class="system-tip" style="display: none;">
        <div class="tip-content"></div>
        <button class="tip-close" onclick="hideSystemTip()">×</button>
    </div>

    <!-- Chat messages -->
    <div id="chat-messages" class="chat-messages"></div>

    <!-- Loading indicator -->
    <div id="loadingIndicator" class="loading hidden">
        <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <!-- Error bubble (hidden by default) -->
    <div id="errorBubble" class="error-bubble hidden"></div>

    <!-- Token usage info (dev only) -->
    <div id="tokenInfo" class="dev-debug"></div>

    <!-- Input form -->
    <form id="chat-form" class="chat-form">
        <div class="input-group">
            <select id="category-override" class="category-select">
                <option value="">Auto-detect category</option>
                <option value="weather">Weather</option>
                <option value="person">Person</option>
                <option value="compare">Compare</option>
                <option value="price">Price</option>
                <option value="translate">Translate</option>
                <option value="summarize">Summarize</option>
                <option value="explain">Explain</option>
            </select>
            <input type="text" id="message-input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </div>
    </form>
</div>

<style>
/* System tip styles */
.system-tip {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    position: relative;
    animation: fadeIn 0.3s ease-in-out;
}

.tip-content {
    color: var(--text-primary);
    font-size: 0.9rem;
    line-height: 1.5;
}

.tip-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.tip-close:hover {
    background: var(--bg-hover);
}

/* Category badge styles */
.category-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    background: var(--accent-color);
    color: white;
}

/* Table styles */
.ai-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    background: var(--bg-secondary);
    border-radius: 8px;
    overflow: hidden;
}

.ai-table th,
.ai-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.ai-table th {
    background: var(--bg-hover);
    font-weight: 600;
}

.ai-table tr:last-child td {
    border-bottom: none;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Loading indicator styles */
.loading {
    text-align: center;
    padding: 1rem;
    margin: 1rem 0;
}

.loading-dots {
    display: inline-flex;
    gap: 0.5rem;
}

.loading-dots span {
    width: 8px;
    height: 8px;
    background: var(--accent-color);
    border-radius: 50%;
    animation: blink 1.2s infinite;
}

.loading-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.loading-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes blink {
    0%, 100% { opacity: 0.2; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1); }
}

/* Error bubble styles */
.error-bubble {
    background: var(--error-color, #ff4c4c);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    font-weight: 500;
    animation: fadeIn 0.3s ease-in-out;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.error-bubble::before {
    content: "⚠️";
    font-size: 1.2rem;
}

/* Token info styles */
.dev-debug {
    font-size: 0.8rem;
    color: var(--text-secondary);
    padding: 0.5rem;
    text-align: center;
    font-family: monospace;
    opacity: 0.7;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .system-tip {
        background: var(--bg-secondary-dark);
        border-color: var(--border-color-dark);
    }
    
    .tip-content {
        color: var(--text-primary-dark);
    }
    
    .tip-close {
        color: var(--text-secondary-dark);
    }
    
    .tip-close:hover {
        background: var(--bg-hover-dark);
    }
    
    .ai-table {
        background: var(--bg-secondary-dark);
    }
    
    .ai-table th,
    .ai-table td {
        border-color: var(--border-color-dark);
    }
    
    .ai-table th {
        background: var(--bg-hover-dark);
    }
    
    .loading-dots span {
        background: var(--accent-color-dark, #60a5fa);
    }
    
    .error-bubble {
        background: var(--error-color-dark, #ef4444);
    }
    
    .dev-debug {
        color: var(--text-secondary-dark);
    }
}
</style>

<script>
// Language definitions
const languages = {
    en: {
        categoryBadge: "Category:",
        copyButton: "Copy",
        copiedButton: "Copied!",
        errorMessage: "An error occurred. Please try again.",
        categories: {
            weather: "Weather",
            person: "Person",
            compare: "Compare",
            price: "Price",
            translate: "Translate",
            summarize: "Summarize",
            explain: "Explain"
        }
    },
    pl: {
        categoryBadge: "Kategoria:",
        copyButton: "Kopiuj",
        copiedButton: "Skopiowano!",
        errorMessage: "Wystąpił błąd. Spróbuj ponownie.",
        categories: {
            weather: "Pogoda",
            person: "Osoba",
            compare: "Porównanie",
            price: "Cena",
            translate: "Tłumaczenie",
            summarize: "Podsumowanie",
            explain: "Wyjaśnienie"
        }
    }
};

// Apply language changes
function applyLanguage(lang) {
    document.querySelectorAll('[data-lang]').forEach(element => {
        const key = element.getAttribute('data-lang');
        if (languages[lang][key]) {
            element.textContent = languages[lang][key];
        }
    });
}

// System tip handling
function showSystemTip(content) {
    const tip = document.getElementById('system-tip');
    const tipContent = tip.querySelector('.tip-content');
    tipContent.innerHTML = content;
    tip.style.display = 'block';
}

function hideSystemTip() {
    const tip = document.getElementById('system-tip');
    tip.style.display = 'none';
}

// Response formatting
function formatResponse(text, category) {
    if (!text) return '';
    
    // Handle table formatting for specific categories
    if (category === 'compare' || category === 'price') {
        const lines = text.split('\n');
        if (lines.length > 1) {
            const headers = lines[0].split('|').map(h => h.trim()).filter(h => h);
            const rows = lines.slice(1).map(line => 
                line.split('|').map(cell => cell.trim()).filter(cell => cell)
            );
            
            if (headers.length > 0 && rows.length > 0) {
                return `
                    <table class="ai-table">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${rows.map(row => `
                                <tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }
    }
    
    return text;
}

// Message handling
function addMessage(content, isUser = false, category = null) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
    
    let messageContent = '';
    
    if (category) {
        const lang = document.documentElement.lang || 'en';
        messageContent += `
            <div class="category-badge">
                ${languages[lang].categoryBadge} ${languages[lang].categories[category] || category}
            </div>
        `;
    }
    
    messageContent += `<div class="message-content">${formatResponse(content, category)}</div>`;
    
    if (!isUser) {
        messageContent += `
            <button class="copy-button" onclick="copyToClipboard(this, '${content.replace(/'/g, "\\'")}')">
                ${languages[document.documentElement.lang || 'en'].copyButton}
            </button>
        `;
    }
    
    messageDiv.innerHTML = messageContent;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Copy to clipboard
function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(() => {
        const lang = document.documentElement.lang || 'en';
        button.textContent = languages[lang].copiedButton;
        setTimeout(() => {
            button.textContent = languages[lang].copyButton;
        }, 2000);
    });
}

// Loading state management
function showLoading() {
    document.getElementById("loadingIndicator").classList.remove("hidden");
    document.getElementById("chat-form").classList.add("disabled");
}

function hideLoading() {
    document.getElementById("loadingIndicator").classList.add("hidden");
    document.getElementById("chat-form").classList.remove("disabled");
}

// Error handling
function showError(message) {
    const errorBubble = document.getElementById("errorBubble");
    const lang = document.documentElement.lang || 'en';
    const defaultMessage = languages[lang].errorMessage;
    errorBubble.textContent = message || defaultMessage;
    errorBubble.classList.remove("hidden");
    setTimeout(() => {
        errorBubble.classList.add("hidden");
    }, 5000);
}

// Token usage display
function updateTokenInfo(tokens) {
    if (!tokens) return;
    
    const tokenInfo = document.getElementById("tokenInfo");
    if (tokenInfo) {
        tokenInfo.textContent = `🧮 Prompt: ${tokens.prompt} | Completion: ${tokens.completion} | Total: ${tokens.total}`;
    }
}

// Form handling
document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const input = document.getElementById('message-input');
    const categoryOverride = document.getElementById('category-override').value;
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage(message, true);
    input.value = '';
    
    // Show loading state
    showLoading();
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                category_override: categoryOverride
            }),
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Show system tip if provided
        if (data.tip) {
            showSystemTip(data.tip);
        }
        
        // Add assistant message
        addMessage(data.response, false, data.category);
        
        // Update token info if available
        if (data.tokens) {
            updateTokenInfo(data.tokens);
        }
        
        // Debug log
        if (data.category) {
            console.log("Category:", data.category);
        }
        
    } catch (error) {
        console.error('Error:', error);
        showError();
    } finally {
        hideLoading();
    }
});

// Language toggle handling
document.querySelectorAll('.language-toggle').forEach(toggle => {
    toggle.addEventListener('click', () => {
        const lang = toggle.getAttribute('data-lang');
        document.documentElement.lang = lang;
        applyLanguage(lang);
    });
});
</script>
{% endblock %} 